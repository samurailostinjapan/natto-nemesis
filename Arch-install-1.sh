#!/bin/bash
#set -e
###############################################################################
# Title	:	ArchLinux Install Script
# Author: 	Natto
###############################################################################
#
#   DO NOT JUST RUN THIS. EXAMINE AND JUDGE. RUN AT YOUR OWN RISK.
#
###############################################################################

echo
echo "###############################################################################"
echo "Update the System Clock"
echo "###############################################################################"
echo
		timedatectl set-ntp true
echo
echo "###############################################################################"
echo "Erasing HDD"
echo "###############################################################################"
echo
		sgdisk --zap-all /dev/vda
echo
echo "###############################################################################"
echo "Creating EFI Partition"
echo "###############################################################################"
echo
		sgdisk -n 1:2048:+300M -t 1:ef00 /dev/vda
echo
echo "###############################################################################"
echo "Creating Root Partition"
echo "###############################################################################"
echo
		sgdisk -n 2:0:+40G -t 2:8300 /dev/vda
echo
echo "###############################################################################"
echo "Creating Swap Partition"
echo "###############################################################################"
echo
		sgdisk -n 3:0:0 -t 3:8200 /dev/vda
echo
echo "###############################################################################"
echo "Formatting SDA1"
echo "###############################################################################"
echo
		mkfs.fat -F32 /dev/vda1
echo
echo "###############################################################################"
echo "Formatting SDA2"
echo "###############################################################################"
echo
		mkfs.ext4 /dev/vda2
echo
echo "###############################################################################"
echo "Making Swap Partition"
echo "###############################################################################"
echo
		mkswap /dev/vda3
echo
echo "###############################################################################"
echo "Turning swap on"
echo "###############################################################################"
echo
		swapon /dev/vda3
echo
echo "###############################################################################"
echo "Mounting Root Partition"
echo "###############################################################################"
echo
		mount /dev/vda2 /mnt
echo
echo "###############################################################################"
echo "Making Boot folder Structure"
echo "###############################################################################"
echo
		mkdir /mnt/boot
echo
echo "###############################################################################"
echo "Making EFI folder Structure"
echo "###############################################################################"
echo
		mkdir /mnt/boot/efi
echo
echo "###############################################################################"
echo "Mounting Boot"
echo "###############################################################################"
echo
		mount /dev/vda1 /mnt/boot/efi
echo
echo "###############################################################################"
echo "Mirrors"
echo "###############################################################################"
echo
		reflector -l 100 -f 50 -c JP --sort rate --threads 5 --verbose --save /tmp/mirrorlist.new && rankmirrors -n 0 /tmp/mirrorlist.new > /tmp/mirrorlist && sudo cp /tmp/mirrorlist /etc/pacman.d
echo
echo "###############################################################################"
echo "Installing Base packages"
echo "###############################################################################"
echo
		pacstrap /mnt base base-devel linux linux-firmware nano
echo
echo "###############################################################################"
echo "Generating FSTAB"
echo "###############################################################################"
echo
		genfstab -U /mnt >> /mnt/etc/fstab
echo
echo "###############################################################################"
echo "Arch-Chrooting"
echo "###############################################################################"
echo
		arch-chroot /mnt
echo
echo "###############################################################################"
echo "Setting Timezone with Symlink"
echo "###############################################################################"
echo
		ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
echo
echo "###############################################################################"
echo "Setting Hardware clock"
echo "###############################################################################"
echo
		hwclock --systohc --utc
echo
echo "###############################################################################"
echo "Setting Locale"
echo "###############################################################################"
echo
		sed -i 's/^#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen
echo
echo "###############################################################################"
echo "Generating Locale"
echo "###############################################################################"
echo
		locale-gen
echo
echo "###############################################################################"
echo "Add LANG Variable to Locale.conf"
echo "###############################################################################"
echo
		echo "LANG=en_US.UTF-8" > /etc/locale.conf
echo
echo "###############################################################################"
echo "Setting Hostname"
echo "###############################################################################"
echo
		echo "archtest" > /etc/hostname
echo
echo "###############################################################################"
echo "Setting Hosts file"
echo "###############################################################################"
echo
		echo "127.0.0.1		localhost" >> /etc/hosts
		echo "::1			localhost" >> /etc/hosts
echo
echo "###############################################################################"
echo "Installing NetworkManager"
echo "###############################################################################"
echo
		pacman -S networkmanager
echo
echo "###############################################################################"
echo "Enabling NetworkManager"
echo "###############################################################################"
echo
		systemctl enable NetworkManager
echo
echo "###############################################################################"
echo "Set Root Password"
echo "###############################################################################"
echo
		echo -e "cangetin\ncangetin" | passwd root
echo
echo "###############################################################################"
echo "Installing BootLoader"
echo "###############################################################################"
echo
		pacman -S grub efibootmgr
echo
echo "###############################################################################"
echo "Grub Install"
echo "###############################################################################"
echo
		grub-install --target=x86_64-efi --efi-directory=/boot/efi
echo
echo "###############################################################################"
echo "Configuring Grub"
echo "###############################################################################"
echo
		grub-mkconfig -o /boot/grub/grub.cfg
echo
echo "###############################################################################"
echo "Leaving Arch-Chroot"
echo "###############################################################################"
echo
		exit
echo
echo "###############################################################################"
echo "Umounting /mnt"
echo "###############################################################################"
echo
		umount -R /mnt
echo
echo "###############################################################################"
echo "Finished "
echo "###############################################################################"
echo
